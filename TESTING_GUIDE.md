# MetroQuickChat 测试指南

## 前置要求

### 1. 开发环境
- ✅ Xcode 15+ 
- ✅ iOS 17+ 设备（蓝牙功能需要真实设备，模拟器不支持）
- ✅ 至少2台iOS设备用于测试蓝牙通信

### 2. 权限设置
确保以下权限已正确配置：
- **蓝牙权限** - 用于设备发现和通信
- **定位权限** - 用于蓝牙相关功能
- **麦克风权限** - 用于语音消息
- **照片权限** - 用于发送图片

## 运行项目

### 步骤 1: 打开项目
```bash
cd /Users/james/work/code/ios/MetroQuickChat
open MetroQuickChat.xcodeproj
```

### 步骤 2: 选择目标设备
1. 在 Xcode 顶部工具栏选择 **设备**（必须是真实 iPhone/iPad，不能是模拟器）
2. 确保设备已连接并信任电脑

### 步骤 3: 添加 SPM 依赖（如果需要 Exyte.Chat）
1. **File → Add Package Dependencies...**
2. 输入 URL: `https://github.com/exyte/Chat`
3. 选择版本: `2.0.0` 或更高
4. 点击 **Add Package**

### 步骤 4: 配置签名
1. 选择项目 → **Signing & Capabilities**
2. 选择你的开发团队
3. Xcode 会自动配置 Provisioning Profile

### 步骤 5: 运行项目
- 按 `⌘ + R` 或点击运行按钮
- 首次运行会在设备上安装应用

## 测试步骤

### 测试 1: 基础连接（单设备测试）

1. **启动应用**
   - 首次启动会显示权限请求，全部允许

2. **创建频道**
   - 在主页点击 "创建频道"
   - 输入频道名称（如 "测试频道"）
   - 点击创建

3. **查看频道列表**
   - 应该能看到刚创建的频道
   - 显示成员数量

### 测试 2: 蓝牙通信（双设备测试）

**准备工作：**
- 准备2台iOS设备（Device A 和 Device B）
- 确保两台设备蓝牙已开启
- 确保定位服务已开启

**测试流程：**

#### Device A（主机）
1. 打开应用，创建频道 "聊天测试"
2. 等待广播（蓝牙图标应显示）
3. 进入聊天界面

#### Device B（客户端）
1. 打开应用
2. 点击 "雷达扫描" 或等待自动发现
3. 应该能看到 Device A 的频道 "聊天测试"
4. 点击加入频道

#### 验证连接
- Device B 进入聊天界面
- Device A 显示有新成员加入的系统消息
- 两台设备都能看到对方

### 测试 3: 文本消息

**在任一设备：**
1. 在输入框输入文字
2. 点击发送按钮（飞机图标）
3. 应该看到：
   - 消息出现在聊天界面
   - 消息气泡右对齐（自己发送的）
   - 对方设备能收到消息（左对齐）

**验证点：**
- ✅ 消息实时显示
- ✅ 气泡样式正确（蓝色-自己，灰色-他人）
- ✅ 显示时间戳
- ✅ 显示昵称（对方消息）

### 测试 4: Emoji 消息

1. 点击输入栏右侧的 **😊 表情按钮**
2. 选择任意 emoji（如 😀）
3. Emoji 自动添加到输入框
4. 点击发送
5. Emoji 应该正常显示在消息中

**验证点：**
- ✅ Emoji 选择器正常打开
- ✅ Emoji 正确显示
- ✅ 能发送多个 emoji

### 测试 5: 图片消息

1. 点击输入栏右侧的 **📷 相机按钮**
2. 从相册选择一张图片
3. 图片自动压缩并发送
4. 在聊天中显示缩略图

**验证点：**
- ✅ 图片选择器正常打开
- ✅ 图片显示在聊天中
- ✅ 点击图片能全屏查看
- ✅ 图片支持缩放、拖拽

### 测试 6: 语音消息

1. **开始录制**
   - 长按麦克风按钮 🎤
   - 按钮变红色，显示录音指示器
   - 显示 "录音中 X秒"

2. **取消录制**
   - 向上滑动超过 80px
   - 应该取消录制

3. **发送语音**
   - 松开按钮（不向上滑动）
   - 自动发送语音

4. **播放语音**
   - 点击收到的语音消息
   - 显示播放进度条
   - 能暂停/继续

**验证点：**
- ✅ 长按开始录制
- ✅ 上滑取消功能正常
- ✅ 语音发送成功
- ✅ 语音播放正常
- ✅ 进度条更新

### 测试 7: 消息操作（长按菜单）

**测试复制：**
1. 长按任意消息
2. 选择 "复制"
3. 粘贴到其他地方验证

**测试删除：**
1. 长按自己发送的消息
2. 选择 "删除"
3. 消息应该从界面消失

**测试举报：**
1. 长按他人发送的消息
2. 选择 "举报"
3. 显示确认对话框

### 测试 8: 成员管理

1. 点击右上角 **👥 成员按钮**
2. 查看成员列表
3. 显示距离和方位（如果有位置信息）
4. 房主可以踢出成员

## 调试技巧

### 查看日志
在 Xcode 底部控制台查看：
- 蓝牙连接状态
- 消息发送/接收日志
- 错误信息

### 常见问题排查

#### 1. 找不到其他设备
**检查：**
- ✅ 两台设备蓝牙已开启
- ✅ 两台设备定位服务已开启
- ✅ 应用有蓝牙和定位权限
- ✅ 两台设备距离足够近（建议 < 5米）
- ✅ 检查 Xcode 控制台是否有错误

**解决方案：**
```swift
// 在 Xcode 控制台查看：
// 1. 蓝牙状态日志
// 2. 扫描状态
// 3. 连接错误信息
```

#### 2. 消息发送失败
**检查：**
- ✅ 两台设备是否在同一频道
- ✅ 蓝牙连接是否正常
- ✅ 查看控制台错误信息

#### 3. 语音录制没有声音
**检查：**
- ✅ 麦克风权限是否授予
- ✅ 设备音量是否开启
- ✅ 查看控制台是否有 AVAudioSession 错误

#### 4. 图片无法发送
**检查：**
- ✅ 照片库权限是否授予
- ✅ 图片是否过大（会自动压缩）
- ✅ 查看控制台压缩错误

### 调试代码位置

**蓝牙状态：**
```swift
// BluetoothCentralManager.swift
// 查看 state 变化
```

**消息发送：**
```swift
// ChannelManager.swift
// send() 方法中的日志
```

**消息接收：**
```swift
// ChannelManager.swift
// handleIncoming() 方法
```

## 性能测试

### 测试大量消息
1. 快速发送多条消息
2. 验证滚动性能
3. 验证内存使用（Xcode → Debug → Memory）

### 测试长时间连接
1. 保持连接 30 分钟以上
2. 验证蓝牙连接稳定性
3. 验证消息历史加载

## 预期效果清单

### ✅ 必须能看到的：
- [ ] 频道列表界面
- [ ] 聊天界面（Telegram 风格气泡）
- [ ] 消息发送动画
- [ ] Toast 提示（"已发送"等）
- [ ] 语音录制指示器
- [ ] 表情选择器
- [ ] 图片全屏查看器
- [ ] 成员列表

### ✅ 交互效果：
- [ ] 按住麦克风按钮变红色并放大
- [ ] 上滑取消录音
- [ ] 消息气泡有阴影
- [ ] 滚动到最新消息
- [ ] 长按显示菜单

## 如果看不到效果

### 1. 检查编译错误
- 确保没有红色错误标记
- 按 `⌘ + B` 重新编译

### 2. 检查设备连接
- 确保设备已连接并信任
- 尝试拔插数据线重新连接

### 3. 检查权限
- 设置 → 隐私 → 检查所有权限
- 确保全部允许

### 4. 重新安装应用
```bash
# 在设备上删除应用，重新安装
```

### 5. 清理构建
- Xcode: **Product → Clean Build Folder** (`⌘ + Shift + K`)
- 重新运行

### 6. 检查iOS版本
- 确保设备运行 iOS 17+
- 设置 → 通用 → 软件更新

### 7. 蓝牙测试（最重要）
**蓝牙功能必须在真实设备上测试，模拟器不支持！**

如果只有一台设备：
- 可以使用 Xcode 的 **Multiple Simulators**（但仍无法测试蓝牙）
- 建议借用第二台设备，或使用两台自己的设备

## 获取帮助

如果遇到问题：
1. 查看 Xcode 控制台日志
2. 检查设备设置中的权限
3. 查看 `IMPROVEMENTS.md` 了解功能说明
4. 检查代码中的注释

## 快速测试脚本

在 Xcode 中运行以下测试场景：

```swift
// 测试场景 1: 创建频道
1. 打开应用
2. 点击"创建频道"
3. 输入"测试"
4. 点击创建
✅ 应该看到频道列表有"测试"频道

// 测试场景 2: 发送文本
1. 进入频道
2. 输入"Hello"
3. 点击发送
✅ 应该看到蓝色气泡消息

// 测试场景 3: 发送图片
1. 点击相机图标
2. 选择图片
✅ 应该看到图片消息

// 测试场景 4: 发送语音
1. 长按麦克风
2. 说话
3. 松开
✅ 应该看到语音消息
```

---

**提示：** 蓝牙通信测试需要2台真实设备，这是最重要的限制。如果只有模拟器，只能测试UI，无法测试核心的蓝牙通信功能。

